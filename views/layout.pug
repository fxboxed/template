//- views/layout.pug
doctype html
html(lang="en")
  head
    //- Allow child templates to set vars BEFORE defaults are calculated
    block vars

    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")

    //- ---------- Defaults (override via res.locals or via block vars in child templates) ----------
    - var _title     = (typeof title !== "undefined" && title) ? String(title) : "Aptati Arcade";
    - var _desc      = (typeof description !== "undefined" && description) ? String(description) : "Snack-size games and daily puzzles. Tiny games. Big grins.";
    - var _canon     = (typeof canonical !== "undefined" && canonical) ? String(canonical) : "";
    - var _siteName  = (typeof siteName !== "undefined" && siteName) ? String(siteName) : "Aptati Arcade";
    - var _ogType    = (typeof ogType !== "undefined" && ogType) ? String(ogType) : "website";
    - var _ogImage   = (typeof ogImage !== "undefined" && ogImage) ? String(ogImage) : ((typeof defaultOgImage !== "undefined" && defaultOgImage) ? String(defaultOgImage) : "");
    - var _ogWidth   = (typeof ogWidth !== "undefined" && ogWidth) ? String(ogWidth) : "";
    - var _ogHeight  = (typeof ogHeight !== "undefined" && ogHeight) ? String(ogHeight) : "";
    - var _twCard    = (typeof twitterCard !== "undefined" && twitterCard) ? String(twitterCard) : "summary_large_image";
    - var _twImage   = (typeof twitterImage !== "undefined" && twitterImage) ? String(twitterImage) : (_ogImage || "");
    - var _twSite    = (typeof twitterSite !== "undefined" && twitterSite) ? String(twitterSite) : "";
    - var _twCreator = (typeof twitterCreator !== "undefined" && twitterCreator) ? String(twitterCreator) : "";
    - var _robots    = (typeof robots !== "undefined" && robots) ? String(robots) : "";
    - var _gaId      = (typeof gaId !== "undefined" && gaId) ? String(gaId) : "";

    //- Make OG/Twitter image absolute when canonical is absolute (helps scrapers)
    - var _origin = "";
    - if (_canon) { try { _origin = (new URL(_canon)).origin; } catch (e) { _origin = ""; } }
    - var _ogImageAbs = _ogImage;
    - if (_ogImageAbs && _origin && _ogImageAbs.startsWith("/")) { _ogImageAbs = _origin + _ogImageAbs; }
    - var _twImageAbs = _twImage;
    - if (_twImageAbs && _origin && _twImageAbs.startsWith("/")) { _twImageAbs = _origin + _twImageAbs; }

    //- ---------- Core SEO ----------
    title #{_title}
    meta(name="description" content=_desc)
    meta(name="referrer" content="strict-origin-when-cross-origin")
    if _robots
      meta(name="robots" content=_robots)

    if _canon
      link(rel="canonical" href=_canon)

    //- ---------- Open Graph ----------
    meta(property="og:site_name" content=_siteName)
    meta(property="og:title" content=_title)
    meta(property="og:description" content=_desc)
    meta(property="og:type" content=_ogType)
    if _canon
      meta(property="og:url" content=_canon)
    if _ogImageAbs
      meta(property="og:image" content=_ogImageAbs)
      if _ogWidth
        meta(property="og:image:width" content=_ogWidth)
      if _ogHeight
        meta(property="og:image:height" content=_ogHeight)

    //- ---------- Twitter ----------
    meta(name="twitter:card" content=_twCard)
    meta(name="twitter:title" content=_title)
    meta(name="twitter:description" content=_desc)
    if _twImageAbs
      meta(name="twitter:image" content=_twImageAbs)
    if _canon
      meta(name="twitter:url" content=_canon)
    if _twSite
      meta(name="twitter:site" content=_twSite)
    if _twCreator
      meta(name="twitter:creator" content=_twCreator)

    //- ---------- Google Analytics (Consent Mode stub only) ----------
    if _gaId
      script.
        window.__GA_MEASUREMENT_ID__ = "#{_gaId}";
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent','default',{
          analytics_storage:'denied',
          ad_storage:'denied',
          ad_user_data:'denied',
          ad_personalization:'denied'
        });

    block head

    link(rel="stylesheet" href="/css/main.css")

  body
    include ./partials/contact-modal.pug

    .burger#burger
      span.bar
      span.bar
      span.bar

    include ./partials/cookie-consent.pug

    block cookie

    include ./partials/header.pug

    main.site-main(role="main")
      section.container
        block content

    include ./partials/footer.pug

    script(src="/js/aptati-consent.js" defer)
    script(src="/js/nav-toggle.js" defer)
    script(src="/js/contact-modal.js" defer)

    block scripts
